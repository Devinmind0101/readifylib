<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Readify Library - Cloud-based Ebook Storage Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body, html {
      font-family: 'Inter', sans-serif !important;
      background: linear-gradient(135deg, #05346b 0%, #0a2a4d 60%, #1e3a5c 100%) !important;
      color: #fff;
      min-height: 100vh;
      margin: 0;
      font-weight: 400;
    }
    
    .bg-blur-orange, .bg-blur-yellow {
      position: absolute;
      border-radius: 9999px;
      filter: blur(64px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.25;
    }
    
    .bg-blur-orange {
      top: -6rem; 
      left: -6rem; 
      width: 18rem; 
      height: 18rem; 
      background: #f47920;
      filter: blur(64px);
      opacity: 0.25;
    }
    
    .bg-blur-yellow {
      bottom: -8rem; 
      right: -8rem; 
      width: 28rem; 
      height: 28rem; 
      background: #f4a020;
      filter: blur(80px);
      opacity: 0.18;
    }
    
    #mainContent {
      position: relative;
      z-index: 1;
      background: transparent !important;
    }
    
    .animate-in {
      animation: slideInFromTop 0.15s ease-out;
    }
    
    @keyframes slideInFromTop {
      from {opacity: 0; transform: translateY(-6px);}
      to {opacity: 1; transform: translateY(0);}
    }
    
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    
    @keyframes scaleIn {
      from {opacity: 0; transform: scale(0.95);}
      to {opacity: 1; transform: scale(1);}
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .scale-in {
      animation: scaleIn 0.2s ease-out;
    }
    
    .backdrop-blur-sm {
      backdrop-filter: blur(4px);
    }
    
    .text-transparent {
      color: transparent;
    }
    
    .bg-clip-text {
      background-clip: text;
      -webkit-background-clip: text;
    }
    
    /* Enhanced Navigation */
    nav[aria-label="Primary Navigation"] {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: rgba(23, 55, 94, 0.95);
      backdrop-filter: blur(20px);
      color: white;
      width: 18rem;
      position: fixed;
      top: 0; 
      bottom: 0; 
      left: 0;
      z-index: 40;
      overflow-y: auto;
      border-right: 1px solid rgba(244, 121, 32, 0.2);
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
    }
    
    .nav-header {
      padding: 2rem 1.5rem;
      border-bottom: 1px solid rgba(244, 121, 32, 0.15);
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.1) 0%, rgba(244, 160, 32, 0.05) 100%);
    }
    
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .nav-logo-icon {
      width: 2.5rem;
      height: 2.5rem;
      background: linear-gradient(135deg, #f47920, #f4a020);
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);
    }
    
    .nav-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #f4a020;
      letter-spacing: -0.025em;
    }
    
    .nav-subtitle {
      font-size: 0.75rem;
      color: #d1d5db;
      font-weight: 500;
      margin-top: 0.125rem;
    }
    
    /* Enhanced Plus Menu */
    #plusMenuContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    #plusMenuButton {
      width: 3.5rem;
      height: 3.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      border-radius: 1rem;
      background: linear-gradient(135deg, #f47920, #f4a020);
      color: white;
      box-shadow: 0 8px 24px rgba(244, 121, 32, 0.4);
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    #plusMenuButton::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #f4a020, #f47920);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    #plusMenuButton:hover::before {
      opacity: 1;
    }
    
    #plusMenuButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(244, 121, 32, 0.5);
    }
    
    #plusMenuButton span {
      position: relative;
      z-index: 1;
    }
    
    #plusMenuDropdown {
      background: rgba(10, 42, 77, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    
    #plusMenuDropdown button {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
      border: none;
      background: transparent;
      color: #f4a020;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    #plusMenuDropdown button:hover {
      background: rgba(244, 121, 32, 0.15);
      color: white;
      transform: translateX(4px);
    }
    
    /* Enhanced Navigation Items */
    .nav-menu {
      padding: 0 1.5rem;
      flex: 1;
    }
    
    .nav-menu ul {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .nav-menu button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      background: transparent;
      color: #d1d5db;
      cursor: pointer;
    }
    
    .nav-menu button:hover {
      background: rgba(244, 121, 32, 0.15);
      color: #f4a020;
      transform: translateX(4px);
    }
    
    .nav-menu button.active {
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.2), rgba(244, 160, 32, 0.1));
      color: #f4a020;
      font-weight: 600;
      border: 1px solid rgba(244, 121, 32, 0.3);
    }
    
    /* Enhanced Account Section */
    .nav-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(244, 121, 32, 0.15);
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.05) 0%, rgba(244, 160, 32, 0.02) 100%);
    }
    
    #accountButton {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      background: transparent;
      color: #d1d5db;
      cursor: pointer;
    }
    
    #accountButton:hover {
      background: rgba(244, 121, 32, 0.15);
      color: #f4a020;
    }
    
    #accountPopup {
      position: fixed;
      top: 4rem;
      right: 1rem;
      width: 320px;
      background: rgba(10, 42, 77, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      padding: 1.5rem;
      z-index: 60;
      color: #f4a020;
      border: 1px solid rgba(244, 121, 32, 0.3);
      display: none;
      flex-direction: column;
      gap: 1rem;
    }
    
    .account-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(244, 121, 32, 0.2);
    }
    
    .account-avatar {
      width: 3rem;
      height: 3rem;
      background: linear-gradient(135deg, #f47920, #f4a020);
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      font-weight: 600;
    }
    
    .account-info h4 {
      font-weight: 600;
      color: #f4a020;
      margin: 0;
      font-size: 0.875rem;
    }
    
    .account-info p {
      font-size: 0.75rem;
      color: #d1d5db;
      margin: 0.25rem 0 0 0;
    }
    
    .storage-info {
      background: rgba(244, 121, 32, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      font-size: 0.875rem;
      color: #d1d5db;
      border: 1px solid rgba(244, 121, 32, 0.2);
    }
    
    .storage-progress {
      width: 100%;
      height: 0.5rem;
      background: rgba(244, 121, 32, 0.2);
      border-radius: 0.25rem;
      overflow: hidden;
      margin: 0.75rem 0;
    }
    
    .storage-progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #f47920, #f4a020);
      border-radius: 0.25rem;
      transition: width 0.3s ease;
    }
    
    .premium-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: linear-gradient(135deg, #f47920, #f4a020);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .storage-warning {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #fca5a5;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .account-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .account-buttons button {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    
    .btn-logout {
      background: transparent;
      color: #f4a020;
      border: 1px solid rgba(244, 121, 32, 0.3) !important;
    }
    
    .btn-logout:hover {
      background: rgba(244, 121, 32, 0.15);
      color: white;
    }
    
    .btn-premium {
      background: linear-gradient(135deg, #f47920, #f4a020);
      color: white;
      box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);
    }
    
    .btn-premium:hover {
      background: linear-gradient(135deg, #f4a020, #f47920);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(244, 121, 32, 0.4);
    }
    
    /* Enhanced Main Content */
    main {
      margin-left: 18rem;
      padding: 2rem;
      min-height: 100vh;
    }
    
    /* Enhanced Welcome Section */
    #welcomeSection {
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.1) 0%, rgba(244, 160, 32, 0.05) 100%);
      border: 1px solid rgba(244, 121, 32, 0.2);
      border-radius: 1.5rem;
      padding: 2.5rem;
      margin-bottom: 3rem;
      backdrop-filter: blur(10px);
    }
    
    .welcome-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #f4a020, #f47920);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.75rem;
      letter-spacing: -0.025em;
    }
    
    .welcome-subtitle {
      font-size: 1.125rem;
      color: #d1d5db;
      font-weight: 400;
      line-height: 1.6;
    }
    
    /* Enhanced Section Headers */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #f4a020;
    }
    
    .section-title h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .section-title svg {
      width: 1.5rem;
      height: 1.5rem;
    }
    
    /* Enhanced Sort Controls */
    .sort-controls {
      margin-bottom: 1.5rem;
    }
    
    .sort-controls .flex {
      background: rgba(244, 121, 32, 0.1);
      border: 1px solid rgba(244, 121, 32, 0.2);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      backdrop-filter: blur(10px);
    }
    
    .sort-controls select,
    .sort-controls button {
      background: rgba(5, 52, 107, 0.8);
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 0.5rem;
      color: #f4a020;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .sort-controls select:focus,
    .sort-controls button:focus {
      outline: none;
      border-color: #f4a020;
      box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.2);
    }
    
    /* Enhanced Cards */
    .ebook-card {
      background: rgba(10, 42, 77, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(244, 121, 32, 0.2);
      border-radius: 1rem;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      group: true;
    }
    
    .ebook-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(244, 121, 32, 0.4);
    }
    
    .folder-card {
      background: rgba(10, 42, 77, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(244, 121, 32, 0.2);
      border-radius: 1rem;
      padding: 2rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .folder-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(244, 121, 32, 0.4);
      background: rgba(10, 42, 77, 0.8);
    }
    
    .folder-icon {
      width: 4rem;
      height: 4rem;
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.2), rgba(244, 160, 32, 0.1));
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    .folder-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #f4a020;
      margin-bottom: 0.5rem;
    }
    
    .folder-count {
      font-size: 0.875rem;
      color: #d1d5db;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Enhanced Menu Buttons */
    .menu-button {
      opacity: 0;
      transition: all 0.2s ease;
      background: rgba(10, 42, 77, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 0.5rem;
      padding: 0.5rem;
      color: #f4a020;
      cursor: pointer;
    }
    
    .menu-button:hover {
      background: rgba(244, 121, 32, 0.2);
      color: white;
      transform: scale(1.05);
    }
    
    .group:hover .menu-button {
      opacity: 1;
    }
    
    .popup-menu {
      background: rgba(10, 42, 77, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 0.75rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      padding: 0.5rem;
      z-index: 100;
    }
    
    .popup-menu button {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      background: transparent;
      border: none;
      color: #f4a020;
      font-weight: 500;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .popup-menu button:hover {
      background: rgba(244, 121, 32, 0.15);
      color: white;
      transform: translateX(4px);
    }
    
    /* Enhanced Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 52, 107, 0.9);
      backdrop-filter: blur(10px);
      z-index: 110;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .modal-content {
      background: rgba(10, 42, 77, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 1.5rem;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
      padding: 2rem;
      position: relative;
      color: #f4a020;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(244, 121, 32, 0.2);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #f4a020;
      margin: 0;
    }
    
    .modal-close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #f4a020;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
    }
    
    .modal-close-button:hover {
      background: rgba(244, 121, 32, 0.15);
      color: white;
    }
    
    /* Enhanced Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #f4a020;
      margin-bottom: 0.5rem;
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(244, 121, 32, 0.3);
      border-radius: 0.75rem;
      background: rgba(5, 52, 107, 0.8);
      color: #f4a020;
      font-weight: 500;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #f4a020;
      box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.2);
      background: rgba(5, 52, 107, 0.9);
    }
    
    .form-input::placeholder {
      color: rgba(209, 213, 219, 0.6);
    }
    
    /* Enhanced Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #f47920, #f4a020);
      color: white;
      box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #f4a020, #f47920);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(244, 121, 32, 0.4);
    }
    
    .btn-secondary {
      background: transparent;
      color: #f4a020;
      border: 1px solid rgba(244, 121, 32, 0.3);
    }
    
    .btn-secondary:hover {
      background: rgba(244, 121, 32, 0.15);
      color: white;
    }
    
    /* Enhanced Empty States */
    .empty-state {
      background: rgba(10, 42, 77, 0.4);
      border: 2px dashed rgba(244, 121, 32, 0.3);
      border-radius: 1.5rem;
      padding: 4rem 2rem;
      text-align: center;
      color: #f4a020;
    }
    
    .empty-state-icon {
      width: 4rem;
      height: 4rem;
      margin: 0 auto 1.5rem;
      opacity: 0.6;
    }
    
    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .empty-state-description {
      color: #d1d5db;
      margin-bottom: 1.5rem;
    }
    
    /* Enhanced Upload Progress */
    .upload-progress {
      background: rgba(244, 121, 32, 0.1);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid rgba(244, 121, 32, 0.2);
    }
    
    .progress-bar {
      width: 100%;
      height: 0.5rem;
      background: rgba(244, 121, 32, 0.2);
      border-radius: 0.25rem;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #f47920, #f4a020);
      border-radius: 0.25rem;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 0.75rem;
      color: #d1d5db;
      text-align: center;
    }
    
    /* Loading Spinner */
    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(244, 121, 32, 0.3);
      border-top: 2px solid #f4a020;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      nav[aria-label="Primary Navigation"] {
        width: 16rem;
      }
      
      main {
        margin-left: 16rem;
      }
    }
    
    @media (max-width: 768px) {
      nav[aria-label="Primary Navigation"] {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      nav[aria-label="Primary Navigation"].mobile-open {
        transform: translateX(0);
      }
      
      main {
        margin-left: 0;
        padding: 1rem;
      }
      
      .welcome-title {
        font-size: 2rem;
      }
      
      #accountPopup {
        right: 0.5rem;
        left: 0.5rem;
        width: auto;
      }
    }
    
    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 50;
      background: linear-gradient(135deg, #f47920, #f4a020);
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);
    }
    
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
    }
    
    /* Enhanced Grid Layouts */
    .grid-responsive {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    @media (max-width: 640px) {
      .grid-responsive {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }
    }
    
    /* Enhanced Cover Images */
    .cover-image {
      width: 100%;
      height: 12rem;
      object-fit: cover;
      border-radius: 0.75rem 0.75rem 0 0;
      transition: transform 0.3s ease;
    }
    
    .ebook-card:hover .cover-image {
      transform: scale(1.05);
    }
    
    .cover-placeholder {
      width: 100%;
      height: 12rem;
      background: linear-gradient(135deg, rgba(244, 121, 32, 0.1), rgba(244, 160, 32, 0.05));
      border-radius: 0.75rem 0.75rem 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.5rem;
      color: #f4a020;
    }
    
    /* Enhanced Card Content */
    .card-content {
      padding: 1.5rem;
    }
    
    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #f4a020;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }
    
    .card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
    }
    
    .file-type-badge {
      background: linear-gradient(135deg, #f47920, #f4a020);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-weight: 600;
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .upload-date {
      color: #d1d5db;
      font-weight: 500;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col relative">
  <div class="bg-blur-orange"></div>
  <div class="bg-blur-yellow"></div>
  
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle navigation menu">
    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>
  
  <div class="flex flex-1 min-h-0 relative z-10">
    <!-- Enhanced Navigation -->
    <nav aria-label="Primary Navigation" id="mainNav">
      <!-- Enhanced Header -->
      <div class="nav-header">
        <div class="nav-logo">
          <div class="nav-logo-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
          </div>
          <div>
            <div class="nav-title">Readify Library</div>
            <div class="nav-subtitle">Cloud Ebook Storage</div>
          </div>
        </div>
      </div>
      
      <!-- Enhanced Menu Content -->
      <div class="nav-menu">
        <!-- Enhanced Plus Menu -->
        <div id="plusMenuContainer">
          <button id="plusMenuButton" aria-controls="plusMenuDropdown" aria-expanded="false" aria-haspopup="true" title="Add new content">
            <span>+</span>
          </button>
          <div id="plusMenuDropdown" class="hidden absolute left-0 mt-1 w-48 z-50" role="menu">
            <button id="createFolderOption" role="menuitem" type="button">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
              </svg>
              <span>Create Folder</span>
            </button>
            <button id="uploadFilesOption" role="menuitem" type="button">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <span>Upload Files</span>
            </button>
          </div>
        </div>
        
        <!-- Enhanced Navigation Items -->
        <ul>
          <li>
            <button id="navRecentUploads" type="button">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"/>
              </svg>
              <span>Recent Uploads</span>
            </button>
          </li>
          <li>
            <button id="navLibrary" type="button">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
              </svg>
              <span>My Library</span>
            </button>
          </li>
          <li>
            <button id="accountButton" type="button" aria-haspopup="true" aria-expanded="false">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              <span>Account</span>
            </button>
          </li>
        </ul>
      </div>
      
      <!-- Enhanced Footer -->
      <div class="nav-footer">
        <div id="userMenuButton" class="text-sm text-gray-400 truncate">Loading...</div>
      </div>
    </nav>
    
    <!-- Enhanced Account Popup -->
    <div id="accountPopup" role="dialog" aria-modal="true" aria-label="Account options">
      <div class="account-header">
        <div class="account-avatar">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <div class="account-info">
          <h4 id="accountEmail">Loading...</h4>
          <p id="accountStatus">Signed in with Email</p>
        </div>
      </div>
      
      <div class="storage-info">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Storage Usage</span>
          <span id="isPremiumBadge" class="premium-badge hidden">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
            Premium
          </span>
        </div>
        <div class="storage-progress">
          <div class="storage-progress-fill" id="storageProgressFill" style="width: 0%"></div>
        </div>
        <div class="storage-text text-center" id="storageText">0 MB of 500 MB used</div>
        <div id="storageWarning" class="storage-warning hidden">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"/>
          </svg>
          <span id="storageWarningText">Storage almost full!</span>
        </div>
      </div>
      
      <div class="account-buttons">
        <button type="button" class="btn-logout" id="logoutBtn">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Logout
        </button>
        <button type="button" class="btn-premium" id="goPremiumBtn">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
          Go Premium
        </button>
      </div>
    </div>
    
    <!-- Enhanced Main Content -->
    <main id="mainContent">
      <!-- Enhanced Welcome Section -->
      <section id="welcomeSection" class="fade-in">
        <h1 class="welcome-title">Welcome to Readify Library!</h1>
        <p class="welcome-subtitle">Your personal cloud-based ebook collection awaits. Organize, upload, and enjoy your favorite books from anywhere, anytime.</p>
      </section>
      
      <!-- Enhanced Recent Uploads Section -->
      <section id="recentUploadsSection" class="mb-12">
        <div class="section-header">
          <div class="section-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"/>
            </svg>
            <h2>Recent Uploads</h2>
          </div>
        </div>
        <div class="grid-responsive" id="recentUploadsContainer"></div>
      </section>
      
      <!-- Enhanced Library Section -->
      <section id="librarySection" class="mb-12">
        <div class="section-header">
          <div class="section-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            <h2>My Library</h2>
          </div>
        </div>
        <div class="grid-responsive" id="libraryItemsContainer"></div>
      </section>
      
      <!-- Enhanced Folder View Section -->
      <section id="folderViewSection" class="hidden mb-12">
        <div class="section-header">
          <button id="backToLibraryBtn" class="btn btn-secondary">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Library
          </button>
          <div class="section-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <h2 id="folderTitle"></h2>
          </div>
        </div>
        <div class="grid-responsive" id="ebooksContainer"></div>
      </section>
    </main>
  </div>
  
  <!-- Enhanced Upload Modal -->
  <div id="uploadModal" class="hidden modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content scale-in" style="width: 480px;">
      <button class="modal-close-button" id="uploadModalCloseBtn" aria-label="Close upload dialog">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="modal-header">
        <h3 class="modal-title">Upload New Ebook</h3>
      </div>
      
      <form id="uploadModalForm" novalidate>
        <div class="form-group">
          <label for="uploadModalTitle" class="form-label">Ebook Title *</label>
          <input type="text" id="uploadModalTitle" name="uploadModalTitle" required 
                 placeholder="Enter the title of your ebook" class="form-input" />
          <p id="uploadModalTitleError" class="text-red-400 text-xs mt-1 hidden">Please enter a title for the ebook.</p>
        </div>
        
        <div class="form-group">
          <label for="uploadModalFile" class="form-label">Ebook File *</label>
          <input type="file" id="uploadModalFile" name="uploadModalFile" 
                 accept=".pdf,.epub,.mobi,application/pdf" required class="form-input" />
          <p id="uploadModalFileError" class="text-red-400 text-xs mt-1 hidden">Please select an ebook file to upload.</p>
          <p class="text-xs text-gray-400 mt-1">Upload your ebook file (PDF, EPUB, MOBI)</p>
        </div>
        
        <div class="form-group">
          <label for="uploadModalCover" class="form-label">Cover Image (Optional)</label>
          <input type="file" id="uploadModalCover" name="uploadModalCover" 
                 accept="image/*" class="form-input" />
          <p class="text-xs text-gray-400 mt-1">Upload a cover image (JPG, PNG, GIF)</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Cover Preview</label>
          <div class="w-32 h-44 mx-auto bg-gray-800 rounded-xl overflow-hidden border border-orange-500/30 relative">
            <div id="uploadModalCoverPreview" class="w-full h-full flex flex-col items-center justify-center text-orange-400">
              <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mb-2">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="text-xs text-center px-2">No cover selected</span>
            </div>
          </div>
        </div>
        
        <div id="uploadProgress" class="upload-progress hidden">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="progressText">Preparing upload...</div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 border-t border-orange-500/20">
          <button type="button" class="btn btn-secondary" id="uploadCancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <span id="uploadBtnText">Upload Ebook</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Enhanced Create Folder Modal -->
  <div id="createFolderModal" class="hidden modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content scale-in" style="width: 400px;">
      <button class="modal-close-button" id="closeModalBtn" aria-label="Close create folder dialog">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
          </div>
          <h3 class="modal-title">Create New Folder</h3>
        </div>
      </div>
      
      <form id="createFolderForm">
        <div class="form-group">
          <label for="folderName" class="form-label">Folder Name</label>
          <input type="text" id="folderName" placeholder="Enter folder name..." 
                 required autofocus class="form-input" />
        </div>
        
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Create Folder
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Enhanced Rename Modal -->
  <div id="renameModal" class="hidden modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content scale-in" style="width: 400px;">
      <button class="modal-close-button" id="renameModalCloseBtn" aria-label="Close rename dialog">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="modal-header">
        <h3 class="modal-title">Rename Ebook</h3>
      </div>
      
      <div class="form-group">
        <input type="text" id="renameInput" class="form-input" />
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" class="btn btn-secondary" id="renameCancelBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="renameConfirmBtn">Rename</button>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Folder Rename Modal -->
  <div id="folderRenameModal" class="hidden modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content scale-in" style="width: 400px;">
      <button class="modal-close-button" id="folderRenameModalCloseBtn" aria-label="Close folder rename dialog">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="modal-header">
        <h3 class="modal-title">Rename Folder</h3>
      </div>
      
      <div class="form-group">
        <input type="text" id="folderRenameInput" class="form-input" />
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" class="btn btn-secondary" id="folderRenameCancelBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="folderRenameConfirmBtn">Rename</button>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Details Modal -->
  <div id="detailsModal" class="hidden modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content scale-in" style="width: 400px;">
      <button class="modal-close-button" id="detailsModalCloseBtn" aria-label="Close details dialog">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="modal-header">
        <h3 class="modal-title">Ebook Details</h3>
      </div>
      
      <div id="detailsContent" class="space-y-3 text-sm"></div>
      
      <div class="flex justify-end mt-6">
        <button type="button" class="btn btn-primary" id="detailsCloseBtn">Close</button>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://kkqommfzihiigszwtect.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrcW9tbWZ6aWhpaWdzend0ZWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTc1NjQsImV4cCI6MjA2NTU3MzU2NH0.exGr87NfNMhDVXqEDCwdv1AmUxmiLiM5RX8w5e2_4Y8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    lucide.createIcons();

    let folders = [];
    let mainLibraryEbooks = [];
    let currentFolder = null;
    let currentFolderToRename = null;
    let currentEbook = null;
    let currentEbookFolder = null;
    let isUploading = false;

    let librarySortBy = "uploadedAt";
    let librarySortDir = "desc";
    let folderSortBy = "uploadedAt";
    let folderSortDir = "desc";

    // Global user variables
    let userEmail = '';
    let isPremium = false;
    let maxStorage = 500 * 1024 * 1024; // Default 500MB
    let usedStorage = 0;

    // DOM Elements
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mainNav = document.getElementById("mainNav");
    const plusMenuButton = document.getElementById("plusMenuButton");
    const plusMenuDropdown = document.getElementById("plusMenuDropdown");
    const createFolderOption = document.getElementById("createFolderOption");
    const uploadFilesOption = document.getElementById("uploadFilesOption");
    const createFolderModal = document.getElementById("createFolderModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const createFolderForm = document.getElementById("createFolderForm");
    const folderNameInput = document.getElementById("folderName");
    const librarySection = document.getElementById("librarySection");
    const folderViewSection = document.getElementById("folderViewSection");
    const backToLibraryBtn = document.getElementById("backToLibraryBtn");
    const folderTitle = document.getElementById("folderTitle");
    const ebooksContainer = document.getElementById("ebooksContainer");
    const libraryItemsContainer = document.getElementById("libraryItemsContainer");
    const recentUploadsContainer = document.getElementById("recentUploadsContainer");
    const welcomeSection = document.getElementById("welcomeSection");
    const navLibrary = document.getElementById("navLibrary");
    const navRecentUploads = document.getElementById("navRecentUploads");
    const recentUploadsSection = document.getElementById("recentUploadsSection");
    const accountButton = document.getElementById("accountButton");
    const accountPopup = document.getElementById("accountPopup");
    const accountEmail = document.getElementById("accountEmail");
    const accountStatus = document.getElementById("accountStatus");
    const logoutBtn = document.getElementById("logoutBtn");
    const goPremiumBtn = document.getElementById("goPremiumBtn");
    const inPremiumBadge = document.getElementById("inPremiumBadge");
    const storageText = document.getElementById("storageText");
    const storageProgressFill = document.getElementById("storageProgressFill");
    const storageWarning = document.getElementById("storageWarning");
    const storageWarningText = document.getElementById("storageWarningText");
    const renameModal = document.getElementById("renameModal");
    const renameModalCloseBtn = document.getElementById("renameModalCloseBtn");
    const renameInput = document.getElementById("renameInput");
    const renameCancelBtn = document.getElementById("renameCancelBtn");
    const renameConfirmBtn = document.getElementById("renameConfirmBtn");
    const detailsModal = document.getElementById("detailsModal");
    const detailsModalCloseBtn = document.getElementById("detailsModalCloseBtn");
    const detailsCloseBtn = document.getElementById("detailsCloseBtn");
    const detailsContent = document.getElementById("detailsContent");
    const uploadModal = document.getElementById("uploadModal");
    const uploadModalCloseBtn = document.getElementById("uploadModalCloseBtn");
    const uploadModalForm = document.getElementById("uploadModalForm");
    const uploadModalTitle = document.getElementById("uploadModalTitle");
    const uploadModalFile = document.getElementById("uploadModalFile");
    const uploadModalCover = document.getElementById("uploadModalCover");
    const uploadModalCoverPreview = document.getElementById("uploadModalCoverPreview");
    const uploadModalTitleError = document.getElementById("uploadModalTitleError");
    const uploadModalFileError = document.getElementById("uploadModalFileError");
    const uploadProgress = document.getElementById("uploadProgress");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const uploadSubmitBtn = document.getElementById("uploadSubmitBtn");
    const uploadBtnText = document.getElementById("uploadBtnText");
    const uploadCancelBtn = document.getElementById("uploadCancelBtn");
    const folderRenameModal = document.getElementById("folderRenameModal");
    const folderRenameModalCloseBtn = document.getElementById("folderRenameModalCloseBtn");
    const folderRenameInput = document.getElementById("folderRenameInput");
    const folderRenameCancelBtn = document.getElementById("folderRenameCancelBtn");
    const folderRenameConfirmBtn = document.getElementById("folderRenameConfirmBtn");

    // Check authentication and redirect if not logged in
    async function checkAuth() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        
        if (error || !user) {
          window.location.href = 'signup.html';
          return null;
        }
        
        userEmail = user.email || '';
        
        // Fetch user premium status from database
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('in_premium')
          .eq('id', user.id)
          .single();
        
        if (userError) {
          console.error('Error fetching user data:', userError);
          inPremium = false;
        } else {
          isPremium = userData?.in_premium || false;
        }
        
        // Set storage limit based on premium status
        maxStorage = inPremium ? (5 * 1024 * 1024 * 1024) : (500 * 1024 * 1024); // 5GB : 500MB
        
        return user;
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = 'signup.html';
        return null;
      }
    }

    // Calculate used storage
    function calculateUsedStorage() {
      let used = 0;
      folders.forEach(f => f.ebooks.forEach(e => used += e.size || 0));
      mainLibraryEbooks.forEach(e => used += e.size || 0);
      usedStorage = used;
      return used;
    }

    // Update UI with user information and storage status
    function updateAccountUI() {
      // Update user info
      accountEmail.textContent = userEmail;
      document.getElementById('userMenuButton').textContent = userEmail;
      
      // Update premium status
      if (inPremium) {
        inPremiumBadge.classList.remove('hidden');
        accountStatus.textContent = 'Premium Member';
        goPremiumBtn.style.display = 'none';
      } else {
        inPremiumBadge.classList.add('hidden');
        accountStatus.textContent = 'Free Account';
        goPremiumBtn.style.display = 'block';
      }

      // Calculate and update storage info
      const used = calculateUsedStorage();
      const usedPercentage = (used / maxStorage) * 100;
      
      storageText.textContent = `${formatBytes(used)} of ${formatBytes(maxStorage)} used`;
      storageProgressFill.style.width = `${Math.min(usedPercentage, 100)}%`;
      
      // Show storage warning if approaching limit
      if (usedPercentage >= 90) {
        storageWarning.classList.remove('hidden');
        if (usedPercentage >= 100) {
          storageWarningText.textContent = 'Storage limit reached!';
        } else {
          storageWarningText.textContent = 'Storage almost full!';
        }
      } else {
        storageWarning.classList.add('hidden');
      }
    }

    // Check if user has enough storage space
    function hasEnoughStorage(fileSize) {
      const used = calculateUsedStorage();
      return (used + fileSize) <= maxStorage;
    }

    // Mobile menu functionality
    mobileMenuBtn.addEventListener("click", () => {
      mainNav.classList.toggle("mobile-open");
    });

    // Close mobile menu when clicking outside
    document.addEventListener("click", (e) => {
      if (!mainNav.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
        mainNav.classList.remove("mobile-open");
      }
    });

    // Event Listeners
    plusMenuButton.addEventListener("click", togglePlusMenu);
    document.addEventListener("click", closePlusMenuOnClickOutside);
    createFolderOption.addEventListener("click", () => { closePlusMenu(); openCreateFolderModal(); });
    uploadFilesOption.addEventListener("click", () => { closePlusMenu(); openUploadModal(); });
    closeModalBtn.addEventListener("click", closeCreateFolderModal);
    cancelBtn.addEventListener("click", closeCreateFolderModal);
    createFolderForm.addEventListener("submit", handleCreateFolder);
    backToLibraryBtn.addEventListener("click", showLibraryView);
    navLibrary.addEventListener("click", () => { showLibraryView(); setActiveNav("library"); });
    navRecentUploads.addEventListener("click", () => { showRecentUploadsView(); setActiveNav("recentUploads"); });
    accountButton.addEventListener("click", (e) => { e.stopPropagation(); toggleAccountPopup(); });
    document.addEventListener("click", (e) => { 
      if (!accountPopup.contains(e.target) && !accountButton.contains(e.target)) closeAccountPopup(); 
    });
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "signup.html";
    });
    goPremiumBtn.addEventListener("click", () => {
      window.location.href = "https://buy.stripe.com/test_28EdR24kD6bx7EjbBL8g001";
    });
    renameModalCloseBtn.addEventListener("click", closeRenameModal);
    renameCancelBtn.addEventListener("click", closeRenameModal);
    renameConfirmBtn.addEventListener("click", confirmRename);
    renameInput.addEventListener("keydown", (e) => { 
      if (e.key === "Enter") { e.preventDefault(); confirmRename(); } 
      else if (e.key === "Escape") { e.preventDefault(); closeRenameModal(); } 
    });
    folderRenameModalCloseBtn.addEventListener("click", closeFolderRenameModal);
    folderRenameCancelBtn.addEventListener("click", closeFolderRenameModal);
    folderRenameConfirmBtn.addEventListener("click", confirmFolderRename);
    folderRenameInput.addEventListener("keydown", (e) => { 
      if (e.key === "Enter") { e.preventDefault(); confirmFolderRename(); } 
      else if (e.key === "Escape") { e.preventDefault(); closeFolderRenameModal(); } 
    });
    detailsModalCloseBtn.addEventListener("click", closeDetailsModal);
    detailsCloseBtn.addEventListener("click", closeDetailsModal);
    detailsModal.addEventListener("click", (e) => { if (e.target === detailsModal) closeDetailsModal(); });
    renameModal.addEventListener("click", (e) => { if (e.target === renameModal) closeRenameModal(); });
    uploadModalCloseBtn.addEventListener("click", closeUploadModal);
    uploadCancelBtn.addEventListener("click", closeUploadModal);
    uploadModalForm.addEventListener("submit", handleUploadModalSubmit);
    uploadModalCover.addEventListener("change", handleUploadModalCoverChange);
    
    document.addEventListener("click", (e) => {
      document.querySelectorAll(".popup-menu:not([style*='display: none'])").forEach(menu => {
        if (!menu.contains(e.target) && !menu.previousElementSibling.contains(e.target)) {
          menu.style.display = "none";
        }
      });
    });

    function toggleAccountPopup() {
      if (accountPopup.style.display === "flex") closeAccountPopup();
      else openAccountPopup();
    }

    function openAccountPopup() {
      accountPopup.style.display = "flex";
      accountButton.setAttribute("aria-expanded", "true");
    }

    function closeAccountPopup() {
      accountPopup.style.display = "none";
      accountButton.setAttribute("aria-expanded", "false");
    }

    function setActiveNav(section) {
      navLibrary.classList.remove("active");
      navRecentUploads.classList.remove("active");
      if (section === "library") {
        navLibrary.classList.add("active");
      } else if (section === "recentUploads") {
        navRecentUploads.classList.add("active");
      }
    }

    function togglePlusMenu(e) {
      e.stopPropagation();
      if (plusMenuDropdown.classList.contains("hidden")) {
        plusMenuDropdown.classList.remove("hidden");
        plusMenuButton.setAttribute("aria-expanded", "true");
      } else closePlusMenu();
    }

    function closePlusMenu() {
      plusMenuDropdown.classList.add("hidden");
      plusMenuButton.setAttribute("aria-expanded", "false");
    }

    function closePlusMenuOnClickOutside(e) {
      if (!plusMenuButton.contains(e.target) && !plusMenuDropdown.contains(e.target)) closePlusMenu();
    }

    function openCreateFolderModal() {
      createFolderModal.classList.remove("hidden");
      folderNameInput.value = "";
      folderNameInput.focus();
    }

    function closeCreateFolderModal() {
      createFolderModal.classList.add("hidden");
    }

    function handleCreateFolder(e) {
      e.preventDefault();
      const name = folderNameInput.value.trim();
      if (!name) return;
      folders.push({ id: Date.now().toString(), name, ebooks: [] });
      renderLibraryItems();
      closeCreateFolderModal();
      showLibraryView();
      setActiveNav("library");
    }

    function sortEbooks(arr, by, dir) {
      return arr.slice().sort((a, b) => {
        let vA = a[by], vB = b[by];
        if (by === "title") {
          vA = (vA || "").toLowerCase();
          vB = (vB || "").toLowerCase();
        }
        if (vA === undefined) return 1;
        if (vB === undefined) return -1;
        if (vA < vB) return dir === "asc" ? -1 : 1;
        if (vA > vB) return dir === "asc" ? 1 : -1;
        return 0;
      });
    }

    function renderLibraryItems() {
      libraryItemsContainer.parentElement.querySelector('.sort-controls')?.remove();
      
      const sortDiv = document.createElement('div');
      sortDiv.className = "sort-controls";
      sortDiv.innerHTML = `
        <div class="flex items-center justify-end gap-3">
          <label class="text-orange-400 font-medium text-sm">Sort by:</label>
          <select id="librarySortBy" class="px-3 py-1.5 rounded-lg text-orange-400 bg-blue-900/80 border border-orange-500/30 text-sm">
            <option value="uploadedAt">Date Added</option>
            <option value="title">Title</option>
            <option value="fileType">File Type</option>
            <option value="size">Size</option>
          </select>
          <button id="librarySortDirBtn" class="px-3 py-1.5 rounded-lg text-orange-400 bg-blue-900/80 border border-orange-500/30 text-sm hover:bg-orange-500/20 transition-colors" title="Toggle sort direction">
            <span id="librarySortDirIcon">↓</span>
          </button>
        </div>
      `;
      libraryItemsContainer.parentElement.insertBefore(sortDiv, libraryItemsContainer);

      const sortedEbooks = sortEbooks(mainLibraryEbooks, librarySortBy, librarySortDir);

      if (folders.length === 0 && sortedEbooks.length === 0) {
        libraryItemsContainer.innerHTML = `
          <div class="col-span-full empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            <div class="empty-state-title">No uploads yet</div>
            <div class="empty-state-description">Start building your digital library by uploading your first ebook</div>
            <button onclick="openUploadModal()" class="btn btn-primary mt-4">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload Your First Ebook
            </button>
          </div>`;
      } else {
        const folderHtml = folders.map(folder => `
          <div onclick="openFolder('${folder.id}')" class="folder-card group">
            <div class="absolute top-4 right-4 flex gap-2">
              <button onclick="event.stopPropagation(); openFolderRenameModal('${folder.id}')" 
                      class="menu-button" aria-label="Rename folder ${folder.name}">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="event.stopPropagation(); deleteFolder('${folder.id}')" 
                      class="menu-button" aria-label="Delete folder ${folder.name}">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
            <div class="folder-icon">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
              </svg>
            </div>
            <h3 class="folder-title" title="${folder.name}">${folder.name}</h3>
            <div class="folder-count">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
              <span>${folder.ebooks.length} ${folder.ebooks.length === 1 ? "ebook" : "ebooks"}</span>
            </div>
            ${folder.ebooks.length > 0 ? `
              <div class="flex -space-x-2 mt-4">
                ${folder.ebooks.slice(0, 3).map((ebook, i) => ebook.coverImage ? `
                  <img src="${ebook.coverImage}" alt="Cover of ${ebook.title}" 
                       class="w-8 h-10 object-cover rounded border-2 border-orange-500/30" style="z-index: ${3 - i}" />
                ` : `
                  <div class="w-8 h-10 bg-blue-900/60 rounded border-2 border-orange-500/30 flex items-center justify-center" style="z-index: ${3 - i}">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                `).join("")}
                ${folder.ebooks.length > 3 ? `
                  <div class="w-8 h-10 bg-blue-900/60 rounded border-2 border-orange-500/30 flex items-center justify-center text-xs font-semibold text-orange-400">
                    +${folder.ebooks.length - 3}
                  </div>
                ` : ""}
              </div>
            ` : ""}
          </div>
        `).join("");

        const ebookHtml = sortedEbooks.map(ebook => `
          <div class="ebook-card group" data-ebook-id="${ebook.id}" data-folder-id="main">
            <div class="absolute top-3 right-3 z-10">
              <button class="menu-button" onclick="toggleEbookMenu(event, '${ebook.id}', 'main')" 
                      aria-label="Open menu for ${ebook.title}">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
              <div class="popup-menu hidden absolute top-8 right-0 w-40" id="menu-main-${ebook.id}">
                <button onclick="openRenameModal('${ebook.id}', 'main')">Rename</button>
                <button onclick="openDetailsModal('${ebook.id}', 'main')">Details</button>
                <button onclick="downloadFile('${ebook.coverImage}', '${ebook.title} Cover')" ${!ebook.coverImage ? 'disabled' : ''}>Download Cover</button>
                <button onclick="downloadFile('${ebook.url}', '${ebook.title}')">Download Ebook</button>
                <button onclick="deleteEbookById('${ebook.id}', 'main')" class="text-red-400">Delete</button>
              </div>
            </div>
            ${ebook.coverImage ? `
              <img src="${ebook.coverImage}" alt="Cover of ${ebook.title}" class="cover-image" />
            ` : `
              <div class="cover-placeholder">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="text-xs font-semibold">${ebook.fileType}</span>
              </div>
            `}
            <div class="card-content">
              <h3 class="card-title cursor-pointer" onclick="openReaderPage('${ebook.id}')" title="${ebook.title}">
                ${ebook.title}
              </h3>
              <div class="card-meta">
                <span class="file-type-badge">${ebook.fileType}</span>
                <span class="upload-date">${formatDate(ebook.uploadedAt)}</span>
              </div>
            </div>
          </div>
        `).join("");

        libraryItemsContainer.innerHTML = folderHtml + ebookHtml;
      }

      lucide.createIcons();

      document.getElementById('librarySortBy').value = librarySortBy;
      document.getElementById('librarySortBy').onchange = e => {
        librarySortBy = e.target.value;
        renderLibraryItems();
      };
      document.getElementById('librarySortDirBtn').onclick = () => {
        librarySortDir = librarySortDir === "asc" ? "desc" : "asc";
        document.getElementById('librarySortDirIcon').innerHTML = librarySortDir === "asc" ? "↑" : "↓";
        renderLibraryItems();
      };
      document.getElementById('librarySortDirIcon').innerHTML = librarySortDir === "asc" ? "↑" : "↓";
    }

    function renderEbooks() {
      ebooksContainer.parentElement.querySelector('.sort-controls')?.remove();
      
      const sortDiv = document.createElement('div');
      sortDiv.className = "sort-controls";
      sortDiv.innerHTML = `
        <div class="flex items-center justify-end gap-3">
          <label class="text-orange-400 font-medium text-sm">Sort by:</label>
          <select id="folderSortBy" class="px-3 py-1.5 rounded-lg text-orange-400 bg-blue-900/80 border border-orange-500/30 text-sm">
            <option value="uploadedAt">Date Added</option>
            <option value="title">Title</option>
            <option value="fileType">File Type</option>
            <option value="size">Size</option>
          </select>
          <button id="folderSortDirBtn" class="px-3 py-1.5 rounded-lg text-orange-400 bg-blue-900/80 border border-orange-500/30 text-sm hover:bg-orange-500/20 transition-colors" title="Toggle sort direction">
            <span id="folderSortDirIcon">↓</span>
          </button>
        </div>
      `;
      ebooksContainer.parentElement.insertBefore(sortDiv, ebooksContainer);

      const sortedEbooks = sortEbooks(currentFolder.ebooks, folderSortBy, folderSortDir);

      if (!currentFolder || sortedEbooks.length === 0) {
        ebooksContainer.innerHTML = `
          <div class="col-span-full empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <div class="empty-state-title">This folder is empty</div>
            <div class="empty-state-description">Upload ebooks using the + button to get started</div>
            <button onclick="openUploadModal()" class="btn btn-primary mt-4">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload Ebooks
            </button>
          </div>`;
      } else {
        ebooksContainer.innerHTML = sortedEbooks.map(ebook => `
          <div class="ebook-card group" data-ebook-id="${ebook.id}" data-folder-id="${currentFolder.id}">
            <div class="absolute top-3 right-3 z-10">
              <button class="menu-button" onclick="toggleEbookMenu(event, '${ebook.id}', '${currentFolder.id}')" 
                      aria-label="Open menu for ${ebook.title}">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
              <div class="popup-menu hidden absolute top-8 right-0 w-40" id="menu-${currentFolder.id}-${ebook.id}">
                <button onclick="openRenameModal('${ebook.id}', '${currentFolder.id}')">Rename</button>
                <button onclick="openDetailsModal('${ebook.id}', '${currentFolder.id}')">Details</button>
                <button onclick="downloadFile('${ebook.coverImage}', '${ebook.title} Cover')" ${!ebook.coverImage ? 'disabled' : ''}>Download Cover</button>
                <button onclick="downloadFile('${ebook.url}', '${ebook.title}')">Download Ebook</button>
                <button onclick="deleteEbookById('${ebook.id}', '${currentFolder.id}')" class="text-red-400">Delete</button>
              </div>
            </div>
            ${ebook.coverImage ? `
              <img src="${ebook.coverImage}" alt="Cover of ${ebook.title}" class="cover-image" />
            ` : `
              <div class="cover-placeholder">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="text-xs font-semibold">${ebook.fileType}</span>
              </div>
            `}
            <div class="card-content">
              <h3 class="card-title cursor-pointer" onclick="openReaderPage('${ebook.id}')" title="${ebook.title}">
                ${ebook.title}
              </h3>
              <div class="card-meta">
                <span class="file-type-badge">${ebook.fileType}</span>
                <span class="upload-date">${formatDate(ebook.uploadedAt)}</span>
              </div>
            </div>
          </div>
        `).join("");
      }

      lucide.createIcons();

      document.getElementById('folderSortBy').value = folderSortBy;
      document.getElementById('folderSortBy').onchange = e => {
        folderSortBy = e.target.value;
        renderEbooks();
      };
      document.getElementById('folderSortDirBtn').onclick = () => {
        folderSortDir = folderSortDir === "asc" ? "desc" : "asc";
        document.getElementById('folderSortDirIcon').innerHTML = folderSortDir === "asc" ? "↑" : "↓";
        renderEbooks();
      };
      document.getElementById('folderSortDirIcon').innerHTML = folderSortDir === "asc" ? "↑" : "↓";
    }

    function renderRecentUploads() {
      const allEbooks = [];
      folders.forEach(folder => folder.ebooks.forEach(ebook => allEbooks.push(ebook)));
      mainLibraryEbooks.forEach(ebook => allEbooks.push(ebook));
      
      const recentUploads = allEbooks
        .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt))
        .slice(0, 12);

      if (recentUploads.length === 0) {
        recentUploadsContainer.innerHTML = `
          <div class="col-span-full empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"/>
            </svg>
            <div class="empty-state-title">No uploads yet</div>
            <div class="empty-state-description">Your recently uploaded ebooks will appear here</div>
            <button onclick="openUploadModal()" class="btn btn-primary mt-4">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload Your First Ebook
            </button>
          </div>`;
      } else {
        recentUploadsContainer.innerHTML = recentUploads.map(ebook => `
          <div class="ebook-card group cursor-pointer" onclick="openReaderPage('${ebook.id}')">
            ${ebook.coverImage ? `
              <img src="${ebook.coverImage}" alt="Cover of ${ebook.title}" class="cover-image" />
            ` : `
              <div class="cover-placeholder">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="text-xs font-semibold">${ebook.fileType}</span>
              </div>
            `}
            <div class="card-content">
              <h3 class="card-title" title="${ebook.title}">${ebook.title}</h3>
              <div class="card-meta">
                <span class="file-type-badge">${ebook.fileType}</span>
                <span class="upload-date">${formatDate(ebook.uploadedAt)}</span>
              </div>
            </div>
          </div>
        `).join("");
      }

      lucide.createIcons();
    }

    function deleteEbookById(ebookId, folderId) {
      let ebook = null;
      if (folderId === "main") {
        ebook = mainLibraryEbooks.find(e => e.id === ebookId);
      } else {
        const folder = folders.find(f => f.id === folderId);
        if (folder) ebook = folder.ebooks.find(e => e.id === ebookId);
      }
      
      if (ebook && confirm(`Are you sure you want to delete "${ebook.title}"?`)) {
        if (folderId === "main") {
          mainLibraryEbooks = mainLibraryEbooks.filter(e => e.id !== ebookId);
        } else {
          const folder = folders.find(f => f.id === folderId);
          if (folder) folder.ebooks = folder.ebooks.filter(e => e.id !== ebookId);
        }
        closeAllMenus();
        renderLibraryItems();
        renderRecentUploads();
        if (currentFolder && currentFolder.id === folderId) renderEbooks();
        updateAccountUI(); // Update storage info
      }
    }

    function deleteFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (folder && confirm(`Are you sure you want to delete "${folder.name}" folder? This will also delete all ebooks inside it.`)) {
        folders = folders.filter(f => f.id !== folderId);
        renderLibraryItems();
        renderRecentUploads();
        updateAccountUI(); // Update storage info
        if (currentFolder && currentFolder.id === folderId) {
          showLibraryView();
          setActiveNav("library");
        }
      }
    }

    function openFolderRenameModal(folderId) {
      currentFolderToRename = folders.find(f => f.id === folderId);
      if (!currentFolderToRename) return;
      folderRenameInput.value = currentFolderToRename.name;
      folderRenameModal.classList.remove("hidden");
      folderRenameInput.focus();
    }

    function closeFolderRenameModal() {
      folderRenameModal.classList.add("hidden");
      currentFolderToRename = null;
    }

    function confirmFolderRename() {
      const newName = folderRenameInput.value.trim();
      if (!newName) return alert("Folder name cannot be empty.");
      if (currentFolderToRename) {
        currentFolderToRename.name = newName;
        renderLibraryItems();
        if (currentFolder && currentFolder.id === currentFolderToRename.id) {
          folderTitle.textContent = newName;
        }
      }
      closeFolderRenameModal();
    }

    function openFolder(folderId) {
      currentFolder = folders.find(f => f.id === folderId);
      if (currentFolder) {
        showFolderView();
        setActiveNav(null);
      }
    }

    function showFolderView() {
      librarySection.classList.add("hidden");
      folderViewSection.classList.remove("hidden");
      recentUploadsSection.classList.add("hidden");
      welcomeSection.classList.add("hidden");
      folderTitle.textContent = currentFolder.name;
      renderEbooks();
    }

    function showLibraryView() {
      folderViewSection.classList.add("hidden");
      librarySection.classList.remove("hidden");
      recentUploadsSection.classList.add("hidden");
      welcomeSection.classList.add("hidden");
      currentFolder = null;
      closeUploadModal();
      renderLibraryItems();
    }

    function showRecentUploadsView() {
      folderViewSection.classList.add("hidden");
      librarySection.classList.add("hidden");
      recentUploadsSection.classList.remove("hidden");
      welcomeSection.classList.remove("hidden");
      currentFolder = null;
      closeUploadModal();
      renderRecentUploads();
    }

    function openUploadModal() {
      uploadModal.classList.remove("hidden");
      uploadModalTitle.value = "";
      uploadModalFile.value = "";
      uploadModalCover.value = "";
      resetUploadModalCoverPreview();
      uploadModalTitleError.classList.add("hidden");
      uploadModalFileError.classList.add("hidden");
      uploadProgress.classList.add("hidden");
      uploadModalTitle.focus();
    }

    function closeUploadModal() {
      if (isUploading) return;
      uploadModal.classList.add("hidden");
      uploadModalForm.reset();
      resetUploadModalCoverPreview();
      uploadModalTitleError.classList.add("hidden");
      uploadModalFileError.classList.add("hidden");
      uploadProgress.classList.add("hidden");
    }

    function isAllowedFileType(file) {
      const allowed = ['pdf', 'epub', 'mobi', 'jpg', 'jpeg', 'png', 'gif'];
      const ext = file.name.split('.').pop().toLowerCase();
      return allowed.includes(ext);
    }

    async function handleUploadModalSubmit(e) {
      e.preventDefault();

      if (isUploading) return;

      const title = uploadModalTitle.value.trim();
      const fileInput = uploadModalFile.files[0];
      const coverInput = uploadModalCover.files[0];
      let valid = true;

      if (!title) {
        uploadModalTitleError.classList.remove("hidden");
        valid = false;
      } else {
        uploadModalTitleError.classList.add("hidden");
      }

      if (!fileInput) {
        uploadModalFileError.classList.remove("hidden");
        valid = false;
      } else {
        uploadModalFileError.classList.add("hidden");
      }

      if (!valid) return;

      if (!isAllowedFileType(fileInput)) {
        alert('Only PDF, EPUB, MOBI, JPG, PNG, and GIF files are allowed for the main file.');
        return;
      }

      if (coverInput) {
        const allowedCovers = ['jpg', 'jpeg', 'png', 'gif'];
        const coverExt = coverInput.name.split('.').pop().toLowerCase();
        if (!allowedCovers.includes(coverExt)) {
          alert('Only JPG, PNG, and GIF files are allowed for the cover image.');
          return;
        }
      }

      // Check storage limit
      const totalFileSize = fileInput.size + (coverInput ? coverInput.size : 0);
      if (!hasEnoughStorage(totalFileSize)) {
        const remainingSpace = maxStorage - calculateUsedStorage();
        alert(`Not enough storage space! You need ${formatBytes(totalFileSize)} but only have ${formatBytes(remainingSpace)} remaining.${!inPremium ? ' Upgrade to Premium for 5GB of storage!' : ''}`);
        return;
      }

      isUploading = true;
      uploadProgress.classList.remove("hidden");
      uploadSubmitBtn.disabled = true;
      uploadBtnText.textContent = "Uploading...";
      uploadSubmitBtn.insertAdjacentHTML('afterbegin', '<div class="spinner mr-2"></div>');

      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          throw new Error("You must be logged in to upload.");
        }

        // Update progress
        progressFill.style.width = "20%";
        progressText.textContent = "Uploading ebook file...";

        const fileExt = fileInput.name.split('.').pop();
        const filePath = `ebooks/${Date.now()}_${title.replace(/\s+/g, '_')}.${fileExt}`;

        const { error: uploadError } = await supabase.storage
          .from('readify-library')
          .upload(filePath, fileInput, { upsert: true });

        if (uploadError) {
          throw new Error("File upload failed: " + uploadError.message);
        }

        progressFill.style.width = "60%";
        progressText.textContent = "Processing file...";

        const { data: urlData } = supabase
          .storage
          .from('readify-library')
          .getPublicUrl(filePath);

        let coverUrl = "";
        if (coverInput) {
          progressText.textContent = "Uploading cover image...";
          const coverExt = coverInput.name.split('.').pop();
          const coverPath = `covers/${Date.now()}_${title.replace(/\s+/g, '_')}.${coverExt}`;
          const { error: coverError } = await supabase.storage
            .from('readify-library')
            .upload(coverPath, coverInput, { upsert: true });
          
          if (!coverError) {
            const { data: coverUrlData } = supabase
              .storage
              .from('readify-library')
              .getPublicUrl(coverPath);
            coverUrl = coverUrlData.publicUrl;
          }
        }

        progressFill.style.width = "80%";
        progressText.textContent = "Saving metadata...";

        const metadata = {
          title: title,
          file_url: urlData.publicUrl,
          cover_url: coverUrl,
          file_type: fileExt.toUpperCase(),
          size: fileInput.size,
          uploaded_at: new Date().toISOString(),
          user_email: user.email,
          folder_id: currentFolder ? currentFolder.id : null
        };

        const { error: insertError } = await supabase
          .from('ebooks')
          .insert([metadata]);

        if (insertError) {
          throw new Error("Metadata save failed: " + insertError.message);
        }

        progressFill.style.width = "100%";
        progressText.textContent = "Upload complete!";

        const ebookObj = {
          id: Date.now().toString(),
          title: title,
          fileType: fileExt.toUpperCase(),
          uploadedAt: new Date().toISOString(),
          size: fileInput.size,
          coverImage: coverUrl,
          url: urlData.publicUrl
        };

        if (currentFolder) {
          currentFolder.ebooks.push(ebookObj);
          renderEbooks();
        } else {
          mainLibraryEbooks.push(ebookObj);
          renderLibraryItems();
        }

        renderRecentUploads();
        updateAccountUI(); // Update storage info
        
        setTimeout(() => {
          closeUploadModal();
          alert("Ebook uploaded successfully!");
        }, 1000);

      } catch (error) {
        console.error("Upload error:", error);
        alert("Upload failed: " + error.message);
      } finally {
        isUploading = false;
        uploadSubmitBtn.disabled = false;
        uploadBtnText.textContent = "Upload Ebook";
        uploadSubmitBtn.querySelector('.spinner')?.remove();
        progressFill.style.width = "0%";
        progressText.textContent = "Preparing upload...";
      }
    }

    function handleUploadModalCoverChange(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (ev) { 
          showUploadModalCoverPreview(ev.target.result); 
        };
        reader.readAsDataURL(file);
      } else {
        resetUploadModalCoverPreview();
      }
    }

    function showUploadModalCoverPreview(src) {
      uploadModalCoverPreview.innerHTML = `
        <img src="${src}" alt="Cover preview" class="w-full h-full object-cover rounded-xl" />
        <button type="button" onclick="removeUploadModalCover()" 
                class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 hover:bg-red-700 transition-colors" 
                aria-label="Remove cover image">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>`;
    }

    function resetUploadModalCoverPreview() {
      uploadModalCoverPreview.innerHTML = `
        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mb-2">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <span class="text-xs text-center px-2">No cover selected</span>`;
    }

    function removeUploadModalCover() {
      uploadModalCover.value = "";
      resetUploadModalCoverPreview();
    }

    function formatDate(date) {
      return new Date(date).toLocaleDateString("en-US", { 
        month: "short", 
        day: "numeric", 
        hour: "2-digit", 
        minute: "2-digit" 
      });
    }

    function toggleEbookMenu(e, ebookId, folderId) {
      e.stopPropagation();
      closeAllMenus();
      const menu = document.getElementById(`menu-${folderId}-${ebookId}`);
      if (menu) {
        menu.style.display = "flex";
        menu.classList.remove("hidden");
        e.currentTarget.setAttribute("aria-expanded", "true");
      }
    }

    function closeAllMenus() {
      document.querySelectorAll(".popup-menu").forEach(menu => {
        menu.style.display = "none";
        menu.classList.add("hidden");
        const btn = menu.previousElementSibling;
        if (btn && btn.getAttribute("aria-expanded") === "true") {
          btn.setAttribute("aria-expanded", "false");
        }
      });
    }

    function openRenameModal(ebookId, folderId) {
      closeAllMenus();
      currentEbookFolder = folderId === "main" ? null : folders.find(f => f.id === folderId);
      currentEbook = folderId === "main" ? 
        mainLibraryEbooks.find(e => e.id === ebookId) : 
        currentEbookFolder ? currentEbookFolder.ebooks.find(e => e.id === ebookId) : null;
      
      if (!currentEbook) return;
      
      renameInput.value = currentEbook.title;
      renameModal.classList.remove("hidden");
      renameInput.focus();
    }

    function closeRenameModal() {
      renameModal.classList.add("hidden");
      currentEbook = null;
      currentEbookFolder = null;
    }

    function confirmRename() {
      const newName = renameInput.value.trim();
      if (!newName) return alert("Name cannot be empty.");
      
      if (currentEbook) {
        currentEbook.title = newName;
        renderLibraryItems();
        if (currentFolder) renderEbooks();
        renderRecentUploads();
      }
      closeRenameModal();
    }

    function openDetailsModal(ebookId, folderId) {
      closeAllMenus();
      let ebook = null;
      if (folderId === "main") {
        ebook = mainLibraryEbooks.find(e => e.id === ebookId);
      } else {
        const folder = folders.find(f => f.id === folderId);
        if (folder) ebook = folder.ebooks.find(e => e.id === ebookId);
      }
      
      if (!ebook) return;
      
      const sizeStr = ebook.size ? formatBytes(ebook.size) : "Unknown";
      const uploadedStr = ebook.uploadedAt ? formatDate(ebook.uploadedAt) : "Unknown";
      
      detailsContent.innerHTML = `
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="font-medium text-gray-300">Name:</span>
            <span class="text-orange-400">${escapeHtml(ebook.title)}</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium text-gray-300">File Type:</span>
            <span class="text-orange-400">${ebook.fileType}</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium text-gray-300">Size:</span>
            <span class="text-orange-400">${sizeStr}</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium text-gray-300">Uploaded:</span>
            <span class="text-orange-400">${uploadedStr}</span>
          </div>
        </div>
      `;
      detailsModal.classList.remove("hidden");
    }

    function closeDetailsModal() {
      detailsModal.classList.add("hidden");
      detailsContent.innerHTML = "";
    }

    function formatBytes(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024, sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, m => ({ 
        '&': '&amp;', 
        '<': '&lt;', 
        '>': '&gt;', 
        '"': '&quot;', 
        "'": '&#39;' 
      })[m]);
    }

    async function loadEbooksFromDb() {
      const user = await checkAuth();
      if (!user) return;

      try {
        const { data: folderRows, error: folderError } = await supabase
          .from('folders')
          .select('*')
          .eq('user_email', user.email);

        const { data: ebookRows, error: ebookError } = await supabase
          .from('ebooks')
          .select('*')
          .eq('user_email', user.email)
          .order('uploaded_at', { ascending: false });

        if (ebookError) {
          console.error('Error loading ebooks:', ebookError.message);
          return;
        }

        mainLibraryEbooks = [];
        folders = [];

        if (folderRows) {
          folders = folderRows.map(folder => ({
            id: folder.id,
            name: folder.name,
            ebooks: []
          }));
        }

        if (ebookRows) {
          ebookRows.forEach(row => {
            const ebookObj = {
              id: row.id,
              title: row.title,
              fileType: row.file_type,
              uploadedAt: row.uploaded_at,
              size: row.size,
              coverImage: row.cover_url,
              url: row.file_url,
              lastRead: row.last_read
            };
            
            if (row.folder_id) {
              const folder = folders.find(f => f.id == row.folder_id);
              if (folder) folder.ebooks.push(ebookObj);
            } else {
              mainLibraryEbooks.push(ebookObj);
            }
          });
        }

        renderLibraryItems();
        renderRecentUploads();
        updateAccountUI();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function downloadFile(url, filename) {
      if (!url) {
        alert("File not available for download.");
        return;
      }
      
      fetch(url)
        .then(resp => resp.blob())
        .then(blob => {
          const link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          setTimeout(() => {
            window.URL.revokeObjectURL(link.href);
            link.remove();
          }, 100);
        })
        .catch(() => alert("Failed to download file."));
    }

    function openReaderPage(ebookId) {
      let ebook = mainLibraryEbooks.find(e => e.id == ebookId);
      if (!ebook && currentFolder) {
        ebook = currentFolder.ebooks.find(e => e.id == ebookId);
      }
      if (!ebook) {
        // Search in all folders
        for (const folder of folders) {
          ebook = folder.ebooks.find(e => e.id == ebookId);
          if (ebook) break;
        }
      }
      if (!ebook) {
        alert("Ebook not found.");
        return;
      }
      window.location.href = ebook.url;
    }

    // Initialize the application
    window.addEventListener('DOMContentLoaded', async () => {
      await loadEbooksFromDb();
      
      // Show recent uploads by default
      librarySection.classList.add("hidden");
      folderViewSection.classList.add("hidden");
      recentUploadsSection.classList.remove("hidden");
      welcomeSection.classList.remove("hidden");
      setActiveNav("recentUploads");
      renderRecentUploads();
    });
  </script>
</body>
</html>